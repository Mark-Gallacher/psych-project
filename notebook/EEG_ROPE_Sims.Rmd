---
title: "EEG ROPE Simulations"
author: "Mark Gallacher"
date: "2022-12-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 8, fig.width = 10)
```

```{r, warning=F, message=F}
# Loading in Packages
library(tidyverse)
library(ggtext)

# loading in User-Defined Functions
source(here::here("my-scripts", "eeg_rope_pipeline.R"))
source(here::here("my-scripts", "eeg_sim_functions.R"))
```
# Overview of Chapter

### Part One - Generate Raw EEG data
In this step, we use 1/F noise generated from a functions derived from Hank Steven's work (original function is available on [GitHub](https://github.com/HankStevens/primer)). After define to templates, one containing an effect and one without, we combine these with noise in order to represent a single trial. We then regenerate the noise again for each participant. 

#### Defining Parameters to Create the Noise and Templates
```{r}

set.seed(314)

true_onset <- 450  ## Effect at 450ms
stim_on <- 300     ## Stimulus is shown at 300ms
freq <- 2          ## Defines resolution of stimulation, frequency of electrode (This is around 500 reading a second)
max_time <- 800    ## End time for Epoch

Xf <- seq(0, max_time, freq) ## start from zero and end at max time, going up in 2ms (freq)
Nf <- length(Xf)   ## Number of timepoints

# Template one only contains zeros
temp1 <- vector(mode = "numeric", length = Nf)  

# Generate ERP Peak
erp <- dnorm(seq(-1.5, 1.5, length.out= 200/freq), 0, 1)
erp <- erp - min(erp)
erp <- erp / max(erp)

# Getting length and storing them for later use
l_erp <- length(erp)
l_temp1 <- length(temp1)
l_pre_stim <- true_onset / freq

# Template 2 contains the ERP peak
temp2 <- c(rep(0, l_pre_stim), erp, rep(0, (l_temp1 - l_erp - l_pre_stim)))
```

#### Visualising the ERP Peak 
```{r}
tibble(x = Xf, y = temp2) |> 
  ggplot(aes(x, y)) +
  geom_line()+
  annotate("rect", xmin = true_onset, xmax = (true_onset+200)-freq, ymin = 0, ymax = 1, alpha = .5, fill = "forestgreen")+
  annotate("rect", xmax = true_onset, xmin = 0, ymin = 0, ymax = 1, alpha = .3)+
  annotate("rect", xmax = max_time, xmin = (true_onset+200)-freq, ymin = 0, ymax = 1, alpha = .3)+
  annotate("text", label = "Null Hypothesis", x = 10, y = .95, hjust = 0)+
  annotate("text", label = "Alternative Hypothesis", x = true_onset, y = .95, hjust = 0, colour = "forestgreen")+
  theme_minimal()+
  scale_y_continuous("Time (ms)", expand = c(0,0))
```

#### Combining Templates with Noise - Simulating 12 "experiments", starting with 2 trials and doubling each time (until 4096 trials)
  
```{r}
sample_size <- 2^(1:12) # number of trials
gsp <- 1 # gamma spectral power 
outvar <- 1 # noise variance

alpha = 0.05 ## Standard Alpha Level for Significance Testing

## Effect Present in template 2 (temp2)
sim_df_1 <- sim_eeg_rope_pipeline(
                      sample_size = sample_size, # Defines Sample Size/ Number of Trials
                      alpha = alpha, 
                      num_time_points = Nf, 
                      max_time = max_time, 
                      cond1_base = temp1, 
                      cond2_base = temp2, 
                      gamma_spec_power = gsp, 
                      noise_var = outvar,       # Influence Noise output - Zero means no Noise
                      stim_onset = stim_on     # Time when Stimulus was "shown"
                      )

## No effect Present (Only using temp1)
sim_df_2 <- sim_eeg_rope_pipeline(
                      sample_size = sample_size, 
                      alpha = alpha, 
                      num_time_points = Nf, 
                      max_time = max_time, 
                      cond1_base = temp1, 
                      cond2_base = temp1, 
                      gamma_spec_power = gsp, 
                      noise_var = outvar,      
                      stim_onset = stim_on    
                      )


```


```{r, include=FALSE}
### Variable for Graphs

fill_alpha = .2
fill_colours = c("azure4", "skyblue", "darkblue")

line_alpha = .7
line_colours = c("#00BFC4", "#F8766D", "deepskyblue4", "darkblue", "black")
line_size = 1


plot_raw_rope <- function(df){
  df |> 
  ggplot(aes(x = time)) +
  geom_line(aes(y = mn_cond1), colour = line_colours[1], alpha = line_alpha) +
  geom_line(aes(y = mn_cond2), colour = line_colours[2], alpha = line_alpha) +
  geom_line(aes(y = mn_diff), colour = line_colours[5]) +
  geom_vline(xintercept = 0, colour = fill_colours[1])+
  geom_hline(yintercept = 0, colour = fill_colours[1])+
  theme_minimal()+
  geom_line(aes(y = raw_sig - 0.1), size = line_size, colour = line_colours[3])+
  geom_line(aes(y = bon_sig), size = line_size, colour = line_colours[4])+
  geom_ribbon(aes(ymax = ci_u, ymin = ci_l), alpha = fill_alpha, fill = fill_colours[1])+
  geom_ribbon(aes(x = time , ymin = null_min, ymax = null_max), alpha = fill_alpha, fill = fill_colours[2], colour = fill_colours[2])+
  geom_ribbon(aes(x = time , ymin = alt_min, ymax = alt_max), alpha = fill_alpha, fill = line_colours[3],  colour = line_colours[3])+
  facet_wrap(~n_trial, scale = "free_y")+
  labs(title = glue::glue(
         "<b>ERP Mean Values across Time with 
         <span style='color:{fill_colours[1]};'>95% Confidence Intervals</span> for Various Sample Sizes</b><br>
         <i><span style='color:{line_colours[4]};'>Mean Difference</span> ,
         <span style='color:{line_colours[1]};'>Condition 1</span> and
         <span style='color:{line_colours[2]};'>Condition 2</span></i>"), 
      subtitle = glue::glue("Lines at Bottom represent significance, 
                            <b span style='color:{line_colours[3]};'>Raw p-values</b span> and 
                            <b span style='color:{line_colours[4]};'>Bonferroni Corrected </b span><br>
                            Regions of Practical Equivalance
                            <b span style='color:{fill_colours[2]};'>Null ROPE</b span> and
                            <b span style='color:{line_colours[3]};'>Raw Alternative ROPE</b span>"))+
  theme(plot.title = element_markdown(lineheight = 1.5),
    plot.subtitle = element_markdown(lineheight = 1.5))+
  scale_x_continuous("Time (ms)")+
  scale_y_continuous("")
}

plot_bonf_rope <- function(df){
  df |> 
  ggplot(aes(x = time)) +
  geom_line(aes(y = mn_cond1), colour = line_colours[1], alpha = line_alpha) +
  geom_line(aes(y = mn_cond2), colour = line_colours[2], alpha = line_alpha) +
  geom_line(aes(y = mn_diff), colour = line_colours[5]) +
  geom_vline(xintercept = 0, colour = fill_colours[1])+
  geom_hline(yintercept = 0, colour = fill_colours[1])+
  theme_minimal()+
  geom_line(aes(y = raw_sig - 0.1), size = line_size, colour = line_colours[3])+
  geom_line(aes(y = bon_sig), size = line_size, colour = line_colours[4])+
  geom_ribbon(aes(ymax = ci_u, ymin = ci_l), alpha = fill_alpha, fill = fill_colours[1])+
  geom_ribbon(aes(x = time , ymin = null_min, ymax = null_max), alpha = fill_alpha, fill = fill_colours[2], colour = fill_colours[2])+
  geom_ribbon(aes(x = time , ymin = alt_bonf_min, ymax = alt_bonf_max), alpha = fill_alpha, fill = line_colours[4],  colour = line_colours[4])+
  facet_wrap(~n_trial, scale = "free_y")+
  labs(title = glue::glue(
         "<b>ERP Mean Values across Time with 
         <span style='color:{fill_colours[1]};'>95% Confidence Intervals</span> for Various Sample Sizes</b><br>
         <i><span style='color:{line_colours[4]};'>Mean Difference</span> ,
         <span style='color:{line_colours[1]};'>Condition 1</span> and
         <span style='color:{line_colours[2]};'>Condition 2</span></i>"), 
      subtitle = glue::glue("Lines at Bottom represent significance, 
                            <b span style='color:{line_colours[3]};'>Raw p-values</b span> and 
                            <b span style='color:{line_colours[4]};'>Bonferroni Corrected </b span><br>
                            Regions of Practical Equivalance
                            <b span style='color:{fill_colours[2]};'>Null ROPE</b span> and
                            <b span style='color:{fill_colours[3]};'>Bonferroni Alternative ROPE</b span>"))+
  theme(plot.title = element_markdown(lineheight = 1.5),
    plot.subtitle = element_markdown(lineheight = 1.5))+
  scale_x_continuous("Time (ms)")+
  scale_y_continuous("")
}

```


```{r, warning=F}
sim_df_1 |> 
  ggplot(aes(x = time)) +
  geom_line(aes(y = mn_cond1), colour = line_colours[1], alpha = line_alpha) +
  geom_line(aes(y = mn_cond2), colour = line_colours[2], alpha = line_alpha) +
  geom_line(aes(y = mn_diff), colour = line_colours[5]) +
  geom_vline(xintercept = 0, colour = fill_colours[1])+
  geom_hline(yintercept = 0, colour = fill_colours[1])+
  theme_minimal()+
  geom_line(aes(y = raw_sig - 0.05), size = line_size, colour =  line_colours[3])+
  geom_line(aes(y = bon_sig), size = line_size, colour = line_colours[4])+
  geom_ribbon(aes(ymax = ci_u, ymin = ci_l), alpha = fill_alpha, fill = fill_colours[1])+
  facet_wrap(~n_trial, scale = "free_y")+
  labs(title = glue::glue(
         "<b>ERP Mean Values across Time with 
         <span style='color:{fill_colours[1]};'>95% Confidence Intervals</span> for Various Sample Sizes</b><br>
         <i><span style='color:{line_colours[4]};'>Mean Difference</span> ,
         <span style='color:{line_colours[1]};'>Condition 1</span> and
         <span style='color:{line_colours[2]};'>Condition 2</span></i>"), 
      subtitle = glue::glue("Lines at Bottom represent significance, 
                            <b span style='color:{line_colours[3]};'>Raw p-values</b span> and 
                            <b span style='color:{line_colours[4]};'>Bonferroni Corrected </b span>"))+
  theme(plot.title = element_markdown(lineheight = 1.5),
    plot.subtitle = element_markdown(lineheight = 1.5))+
  scale_x_continuous("Time (ms)")+
  scale_y_continuous("")
```

### Part Two -  Define ROPEs
### Experiments with an Effect
We are going to define two ROPE (Regions of Practical Equivalence) using the data to represent the null and alternative hypothesis. The Null ROPE will be defined by the 90% quantile range of the mean pre-stimulus electrical activity for both groups and the Alternative ROPE will be defined by the mean differences of only the significant p-values. It may be better specify the range of time points **a priori**, however, I will use two different ROPEs to represent the alternative hypthesis, one defined from raw p-values and the other by bonferroni corrected p-values. This is provide a more conservative definition of an effect, as some results pre-stimulus can be significant and those false positive should not influence the alternative ROPE. 

Once the ROPE is created for an "experiment", it will superimpose the data of the next experiment, to see how the new data fits to the previous study. If the Confidence intervals are perfectly contained in a ROPE, then we can consider that as support for rejecting and maintaining the null hypothesis. For example, if the Confidence interval is inside the Null ROPE, even if the difference is statistically significant, this should likely be interpreted as evidence for keeping the null. Likewise, if the alternative ROPE covers the majority of the ERP amplitude, then that would be evidence of a replication of the underlying effect and thus, evidence to reject the null. 

```{r,  warning=F}
sim_df_1 |> 
  plot_bonf_rope()
```


```{r, warning=F}
sim_df_1 |> 
  plot_raw_rope()
```

As sample size increases the effect becomes more clear and obvious, and the background noise appears to cancel itself out. This in turn increases the size of the alternative ROPEs, both ROPE defined from raw p-values and bonferroni corrected are wided at the larger sample size. However, raw p-values cause the ROPE to cover the entire range of values, including values where an effect is unlikely. Moreover, it appears only the Bonferroni defined ROPE maintains a gap between the two ROPEs, the Null and Alternative, whch would allow easier interpretation. For, if the ROPEs overlap, and the Confidence interval stretches across both, then it is unclear which ROPE it supports, preventing us to make a clear preference of a hypothesis. 

It is worth noting that the peak of each of the effects appears to go above the ROPE, as the quantile range which is used to define these ROPEs would need to contain values larger than what is observed. It may not be suitable to use a ROPE to investigate the maximum values, instead it should likely be used to prevent false positives and ensure the observed difference is outside an interval which represents background noise. 

### Experiments without an Effect

To see how a ROPE can prevent false positives, we ran the EEG simulation but with no underlying effect, therefore any statistically significant results are false positives. 
```{r, warning=F}
sim_df_2 |> 
  plot_bonf_rope()
```

```{r, warning=F}
sim_df_2|> 
  plot_raw_rope()
```

Just like the ROPEs for when there is an underlying effect, the ROPE constructed from raw p-values appears to be less precise and helpful. Here we can see how False positves influence the ROPE whilst no results were significant after bonferroni correction. 

### Evaluating the False Positives with respect to no ROPE, and the different types of ROPEs
The use of a ROPE should reduce the number of false positives, as if the Confidence interval of a statistically significant point is not completely outside the Null ROPE then no conclusions can be made.

It is probably worth replicating this pipeline (the above process) several times to assess behaviour in the long run - as consistency is difficult to assess from a few trials. These following graphs are influenced by randomness, as the noise is randomly generated, so repeating this pipeline should reduce this unwanted influence. 
```{r, collapse=F, message=F}
## Useful to define region where effect is, to know significant results outside that region are caused from noise
effect_time <- c(true_onset - stim_on, true_onset + 200 - freq - stim_on)

fp_df_1 <- sim_df_1 |> 
  mutate(
    fp = if_else( p < alpha & (time < effect_time[1] | time > effect_time[2]), 1, 0),
    fp_bonf = if_else( p < alpha/Nf & (time < effect_time[1] | time > effect_time[2]), 1, 0),
    fp_rope = if_else( p < alpha & (time < effect_time[1] | time > effect_time[2]) & (ci_u < null_min | ci_l > null_max), 1, 0)
         ) |> 
  group_by(n_trial, fp) |> 
  mutate(sum_fp = sum(fp)/Nf,
         sum_fp_bonf = sum(fp_bonf)/Nf,
         sum_fp_rope = sum(fp_rope)/Nf) |> 
  ungroup() |> 
  pivot_longer(cols = contains("sum"), names_to = "fp_sum", values_to = "prop")

fp_df_2 <- sim_df_2 |> 
  mutate(
    fp = if_else( p < alpha, 1, 0),
    fp_bonf = if_else( p < alpha/Nf, 1, 0),
    fp_rope = if_else( p < alpha & (ci_u < null_min | ci_l > null_max), 1, 0)
         ) |> 
  group_by(n_trial, fp) |> 
  mutate(sum_fp = sum(fp)/Nf,
         sum_fp_bonf = sum(fp_bonf)/Nf,
         sum_fp_rope = sum(fp_rope)/Nf) |> 
  ungroup() |> 
  pivot_longer(cols = contains("sum"), names_to = "fp_sum", values_to = "prop")
```


```{r}
fp_df_1 |> 
  filter(fp == 1) |> 
  ggplot(aes(n_trial, prop, colour = fp_sum))+
  geom_line()+
  geom_point()+
  scale_x_log10("Sample Size")+
  scale_y_continuous("FWER")+
  scale_color_discrete(name = "Method", labels = c("Raw p-values", "Bonferroni Correction","ROPE"))+
  ggtitle("Minimising False Positves across Difference Sample Sizes")+
  theme_minimal()

```

```{r}
fp_df_2 |> 
  filter(fp == 1) |> 
  ggplot(aes(n_trial, prop, colour = fp_sum))+
  geom_line()+
  geom_point()+
  scale_x_log10("Sample Size")+
  scale_y_continuous("FWER")+
  scale_color_discrete(name = "Method", labels = c("Raw p-values", "Bonferroni Correction","ROPE"))+
  ggtitle("Minimising False Positves across Difference Sample Sizes")+
  theme_minimal()
```

Raw p-values are going to generate false positives, which is expected after doing around 400 t-tests. The ROPE does seem to catch some of these, as if the Confidence interval overlaps with the ROPE, then we don't conclude it is a significant difference and without a decision. However, bonferroni corrected p-values seems to be prefect as controlling for false positives, which is probably because of the multivariate approach used in the analysis. IF the EEG was analysed with the mean amplitude then bonferroni correction will start to resemble the raw p values, and hopefully the ROPE will still be effect. 

Next steps:
Repeat pipeline to get smooth curves and long-term behaviour of the various methods
Repeat pipeline but analyse data using mean amplitude instead of t-tests at every time point
Add references to Laken's and Kruschke's work, tidy up unprofessional language. 





